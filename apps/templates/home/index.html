{% extends 'layouts/base.html' %}
{% load static %}

{% block title %} Dashboard {% endblock title %}

<!-- Specific CSS goes HERE -->
{% block stylesheets %}{% endblock stylesheets %}

{% block content %}

<div class="container-fluid py-4">

  <div class="row">
    <div class="col-xl-4 col-sm mb-xl-0 mb-4">
      <div class="card">
        <div class="card-body p-3">
          <div class="row">
            <div class="col-8">
              <div class="numbers">
                <p class="text-sm mb-0 font-weight-bold">Заказов сегодня</p>
                <h5 class="font-weight-bolder mb-0">
                  {% if today_orders %} {{ today_orders }} {% else %} 0 {% endif %}
                </h5>
              </div>
            </div>
            <div class="col-4 text-end">
              <div class="icon icon-shape bg-gradient-primary shadow text-center border-radius-md">
                <i class="fa fa-cart-plus text-lg opacity-10" aria-hidden="true"></i>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-xl-4 col-sm mb-xl-0 mb-4">
      <div class="card">
        <div class="card-body p-3">
          <div class="row">
            <div class="col-8">
              <div class="numbers">
                <p class="text-sm mb-0 font-weight-bold">Выручка сегодня</p>
                <h5 class="font-weight-bolder mb-0">
                  {% if today_revenue %} {{ today_revenue }} {% else %} 0 {% endif %} ₽
                </h5>
              </div>
            </div>
            <div class="col-4 text-end">
              <div class="icon icon-shape bg-gradient-primary shadow text-center border-radius-md">
                <i class="fa fa-coins text-lg opacity-10" aria-hidden="true"></i>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-xl-4 col-sm">
      <div class="card">
        <div class="card-body p-3">
          <div class="row">
            <div class="col-8">
              <div class="numbers">
                <p class="text-sm mb-0 font-weight-bold">Прибыль сегодня</p>
                <h5 class="font-weight-bolder mb-0">
                  {% if today_profit %} {{ today_profit }} {% else %} 0 {% endif %} ₽
                </h5>
              </div>
            </div>
            <div class="col-4 text-end">
              <div class="icon icon-shape bg-gradient-primary shadow text-center border-radius-md">
                <i class="fa fa-piggy-bank text-lg opacity-10" aria-hidden="true"></i>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="row mt-4">
    <div class="col-lg-5 mb-lg-0 mb-4">
      <div class="card z-index-2">
        <div class="card-body p-3">
          <div class="bg-gradient-dark border-radius-lg py-3 pe-1 mb-3">
            <div class="chart">
              <canvas id="chart-bars" class="chart-canvas" height="170"></canvas>
            </div>
          </div>
          <h6 class="ms-2 mt-4 mb-0"> Клиенты </h6>
          <p class="text-sm ms-2"> (<span class="font-weight-bolder">+23%</span>) от прошлой недели </p>
        </div>
      </div>
    </div>
    <div class="col-lg-7">
      <div class="card z-index-2">
        <div class="card-header pb-0 d-flex justify-content-between align-items-center">
          <h6>Продажи</h6>
          <!-- Dropdown для выбора периода -->
          <select id="timePeriod" class="form-select" style="width: 150px;" onchange="updateChart()">
            <option value="week">За неделю</option>
            <option value="month">За месяц</option>
            <option value="year">За год</option>
          </select>
        </div>
        <!-- Line Chart -->
        <div class="card-body">
          <!-- Chart -->
          <div class="chart">
            <!-- Chart wrapper -->
            <canvas id="salesChart" class="chart-canvas"></canvas>
          </div>
        </div>
      </div>
    </div>

  </div>

  {% include "includes/footer.html" %}
</div>

{% endblock content %}

<!-- Specific JS goes HERE -->
{% block javascripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
let salesChart;

function updateChart() {
    const timePeriod = document.getElementById('timePeriod').value;
    fetch(`/api/orders/total-info/?period=${timePeriod}`)
        .then(response => response.json())
        .then(data => {
            const chartData = data.data;
            const labels = chartData.map(item => item.date);
            const revenueData = chartData.map(item => item.revenue);
            const profitData = chartData.map(item => item.profit);

            if (salesChart) {
                salesChart.destroy();
            }

            const ctx = document.getElementById('salesChart').getContext('2d');
            salesChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Выручка',
                            data: revenueData,
                            borderColor: 'rgb(75, 192, 192)',
                            tension: 0.1
                        },
                        {
                            label: 'Прибыль',
                            data: profitData,
                            borderColor: 'rgb(255, 99, 132)',
                            tension: 0.1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        });
}

document.addEventListener('DOMContentLoaded', updateChart);
</script>
{% endblock javascripts %}