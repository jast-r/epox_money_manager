{% extends 'layouts/base.html' %}
{% load static %}

{% block title %} Dashboard {% endblock title %}

<!-- Specific CSS goes HERE -->
{% block stylesheets %}
<style>
  .period-control-group {
    border: 1px solid #d2d6da;
    border-radius: 0.375rem;
    overflow: hidden;
  }

  #prevPeriod,
  #nextPeriod {
    border: none;
    background: none;
    color: #344767;
    padding: 0.25rem 0.5rem;
    font-size: 0.875rem;
    line-height: 1.5;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 32px;
    height: 32px;
    margin-bottom: 0;
    outline: none;
  }

  #prevPeriod:hover,
  #nextPeriod:hover {
    background-color: #f8f9fa;
  }

  #prevPeriod:focus,
  #nextPeriod:focus {
    box-shadow: none;
  }

  #currentPeriod {
    border: none;
    font-size: 0.875rem;
    padding: 0.25rem 0.5rem;
    width: 180px;
    text-align: center;
    background-color: #fff;
  }

  #currentPeriod:focus {
    box-shadow: none;
  }

  #timePeriod {
    width: 120px;
    font-size: 0.875rem;
  }

  #prevPeriod .fas,
  #nextPeriod .fas {
    font-size: 0.75rem;
  }
</style>
{% endblock stylesheets %}

{% block content %}

<div class="container-fluid py-4">

  <div class="row">
    <div class="col-xl-4 col-sm mb-xl-0 mb-4">
      <div class="card">
        <div class="card-body p-3">
          <div class="row">
            <div class="col-8">
              <div class="numbers">
                <p class="text-sm mb-0 font-weight-bold">Заказов сегодня</p>
                <h5 class="font-weight-bolder mb-0">
                  {% if today_orders %} {{ today_orders }} {% else %} 0 {% endif %}
                </h5>
              </div>
            </div>
            <div class="col-4 text-end">
              <div class="icon icon-shape bg-gradient-primary shadow text-center border-radius-md">
                <i class="fa fa-cart-plus text-lg opacity-10" aria-hidden="true"></i>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-xl-4 col-sm mb-xl-0 mb-4">
      <div class="card">
        <div class="card-body p-3">
          <div class="row">
            <div class="col-8">
              <div class="numbers">
                <p class="text-sm mb-0 font-weight-bold">Выручка сегодня</p>
                <h5 class="font-weight-bolder mb-0">
                  {% if today_revenue %} {{ today_revenue }} {% else %} 0 {% endif %} ₽
                </h5>
              </div>
            </div>
            <div class="col-4 text-end">
              <div class="icon icon-shape bg-gradient-primary shadow text-center border-radius-md">
                <i class="fa fa-coins text-lg opacity-10" aria-hidden="true"></i>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-xl-4 col-sm">
      <div class="card">
        <div class="card-body p-3">
          <div class="row">
            <div class="col-8">
              <div class="numbers">
                <p class="text-sm mb-0 font-weight-bold">Прибыль сегодня</p>
                <h5 class="font-weight-bolder mb-0">
                  {% if today_profit %} {{ today_profit }} {% else %} 0 {% endif %} ₽
                </h5>
              </div>
            </div>
            <div class="col-4 text-end">
              <div class="icon icon-shape bg-gradient-primary shadow text-center border-radius-md">
                <i class="fa fa-piggy-bank text-lg opacity-10" aria-hidden="true"></i>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="row mt-4">
    <div class="col-lg-7">
      <div class="card z-index-2">
        <div class="card-header pb-0">
          <div class="row align-items-center">
            <div class="col-auto">
              <h6 class="mb-0">Продажи</h6>
            </div>
            <div class="col text-center">
              <div class="period-control-group d-inline-flex">
                <button id="prevPeriod" class="btn btn-outline-primary btn-sm">
                  <i class="fas fa-chevron-left"></i>
                </button>
                <input type="text" id="currentPeriod" class="form-control form-control-sm text-center" readonly>
                <button id="nextPeriod" class="btn btn-outline-primary btn-sm">
                  <i class="fas fa-chevron-right"></i>
                </button>
              </div>
            </div>
            <div class="col-auto">
              <select id="timePeriod" class="form-select form-select-sm">
                <option value="week">За неделю</option>
                <option value="month">За месяц</option>
                <option value="year">За год</option>
              </select>
            </div>
          </div>
        </div>
        <!-- Line Chart -->
        <div class="card-body">
          <!-- Chart -->
          <div class="chart">
            <!-- Chart wrapper -->
            <canvas id="salesChart" class="chart-canvas"></canvas>
          </div>
        </div>
      </div>
      <div class="row mt-4">
        <div class="col">
          <div class="card">
            <div class="card-body p-3">
              <div class="row">
                <div class="col-8">
                  <div class="numbers">
                    <p class="text-sm mb-0 font-weight-bold">Выручка за период</p>
                    <h5 class="period-revenue font-weight-bolder mb-0">
                      {% if period_revenue %} {{ period_revenue }} {% else %} 0 {% endif %} ₽
                    </h5>
                  </div>
                </div>
                <div class="col-4 text-end">
                  <div class="icon icon-shape bg-gradient-primary shadow text-center border-radius-md">
                    <i class="fa fa-coins text-lg opacity-10" aria-hidden="true"></i>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col">
          <div class="card">
            <div class="card-body p-3">
              <div class="row">
                <div class="col-8">
                  <div class="numbers">
                    <p class="text-sm mb-0 font-weight-bold">Прибыль за период</p>
                    <h5 class="period-profit font-weight-bolder mb-0">
                      {% if period_profit %} {{ period_profit }} {% else %} 0 {% endif %} ₽
                    </h5>
                  </div>
                </div>
                <div class="col-4 text-end">
                  <div class="icon icon-shape bg-gradient-primary shadow text-center border-radius-md">
                    <i class="fa fa-wallet text-lg opacity-10" aria-hidden="true"></i>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-lg-5 mb-lg-0 mb-4">
      <div class="card z-index-2">
        <div class="card-header pb-0 d-flex justify-content-between align-items-center">
          <h6>Клиенты</h6>
        </div>
        <div class="card-body p-3">
          <div class="chart">
            <div class="">
              <canvas id="customersChart" class="chart-canvas" height="170"></canvas>
            </div>
          </div>
        </div>
      </div>
      <div class="row mt-4">
        <div class="col">
          <div class="card">
            <div class="card-body p-3">
              <div class="row">
                <div class="col-8">
                  <div class="numbers">
                    <p class="text-sm mb-0 font-weight-bold">Клиентов за период</p>
                    <h5 class="period-customers font-weight-bolder mb-0">
                      {% if period_customers %} {{ period_customers }} {% else %} 0 {% endif %} ₽
                    </h5>
                  </div>
                </div>
                <div class="col-4 text-end">
                  <div class="icon icon-shape bg-gradient-primary shadow text-center border-radius-md">
                    <i class="fa fa-user-friends text-lg opacity-10" aria-hidden="true"></i>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col">
          <div class="card">
            <div class="card-body p-3">
              <div class="row">
                <div class="col-8">
                  <div class="numbers">
                    <p class="text-sm mb-0 font-weight-bold">Заказов за период</p>
                    <h5 class="period-orders font-weight-bolder mb-0">
                      {% if period_orders %} {{ period_orders }} {% else %} 0 {% endif %} ₽
                    </h5>
                  </div>
                </div>
                <div class="col-4 text-end">
                  <div class="icon icon-shape bg-gradient-primary shadow text-center border-radius-md">
                    <i class="fa fa-cart-plus text-lg opacity-10" aria-hidden="true"></i>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  {% include "includes/footer.html" %}
</div>

{% endblock content %}

<!-- Specific JS goes HERE -->
{% block javascripts %}
<script>
  let startDate = new Date();

  $(function () {

    updateTotalInfo();

    $('#prevPeriod').click(function () {
      changePeriod('prev');
    });

    $('#nextPeriod').click(function () {
      changePeriod('next');
    });

    $('#timePeriod').change(function () {
      updateTotalInfo();
    });
  });

  function changePeriod(direction) {
    const period = $('#timePeriod').val();
    let newStartDate = new Date(startDate);

    switch (period) {
      case 'week':
        newStartDate.setDate(newStartDate.getDate() - 7);
        break;
      case 'month':
        newStartDate.setMonth(newStartDate.getMonth() - 1);
        break;
      case 'year':
        newStartDate.setFullYear(newStartDate.getFullYear() - 1);
        break;
    }

    if (direction === 'next') {
      newStartDate = new Date(startDate);
      switch (period) {
        case 'week':
          console.log("AYYY")
          newStartDate.setDate(newStartDate.getDate() + 7);
          break;
        case 'month':
          newStartDate.setMonth(newStartDate.getMonth() + 1);
          break;
        case 'year':
          newStartDate.setFullYear(newStartDate.getFullYear() + 1);
          break;
      }
    }

    console.log(newStartDate)

    startDate = newStartDate;

    const dateRange = getDateRange(period, newStartDate);
    updateTotalInfo(newStartDate);
  }

  function formatDate(date) {
    return date.toLocaleDateString('ru-RU', {
      day: '2-digit',
      month: '2-digit',
      year: 'numeric'
    }).replace(/\//g, '.');
  }

  function updateTotalInfo(startDate = new Date()) {
    const period = document.getElementById('timePeriod').value;
    const dateRange = getDateRange(period, startDate);

    let start_date = dateRange.firstDay;
    let end_date = dateRange.lastDay;

    console.log(start_date, end_date)

    fetch(`/api/orders/total-info/?start_date=${start_date}&end_date=${end_date}`)
      .then(response => response.json())
      .then(data => {
        const chartData = data.data;
        const labels = chartData.map(item => item.date ? item.date : item.month);

        if (salesChart) {
          salesChart.destroy();
        }

        if (customersChart) {
          customersChart.destroy();
        }

        drawCharts(chartData, labels);
        period_revenue = data.period_revenue.toFixed(1);
        period_profit = data.period_profit.toFixed(1);
        period_customers = data.period_customers;
        period_orders = data.period_orders;

        $('.period-revenue').text(period_revenue + " ₽");
        $('.period-profit').text(period_profit + " ₽");
        $('.period-customers').text(period_customers);
        $('.period-orders').text(period_orders);
        $('#currentPeriod').val(start_date.replace(/-/g, '.') + ' — ' + end_date.replace(/-/g, '.'));
      })
  }
</script>
{% endblock javascripts %}