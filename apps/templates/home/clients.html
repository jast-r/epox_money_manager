{% extends 'layouts/base.html' %}
{% load static %}

{% block title %} Клиенты {% endblock title %}

<!-- Specific CSS goes HERE -->
{% block stylesheets %}{% endblock stylesheets %}

{% block content %}

<div class="container-fluid py-4">

  <div class="row">
    <div class="col-xl-12">
      <div class="card" id="clientsList">
        <div class="card-header border-0">
          <div class="row align-items-center">
            <div class="col">
              <h3 class="mb-0">Клиенты</h3>
            </div>
            <div class="col text-end">
              {#                            <form action="">{% csrf_token %}</form>#}
              <a class="btn bg-gradient-dark mb-0 ms-auto get-client-form" href="{% url 'clients' %}">
                <i class="fas fa-plus me-2"></i>Новый клиент
              </a>
            </div>
          </div>
        </div>
        <div class="table-responsive">
          <!-- Clients table -->
          <table class="table align-items-center table-flush clients-list">
            <thead class="thead-light">
              <tr>
                <th scope="col">ID</th>
                <th scope="col">Имя</th>
                <th scope="col">Ник в тг</th>
                <th scope="col">Номер телефона</th>
                <th scope="col"> &nbsp;</th>
              </tr>
            </thead>
            <tbody>
              {% if clients %}
              {% for client in clients %}
              <tr>
                <th scope="row">{{ client.id }}</th>
                <td>{{ client.name }}</td>
                <td>{{ client.tg_username }}</td>
                <td>{{ client.phone }}</td>
                <td>
                  <a href="{% url 'clients' client.id %}" class="get-client-form">Изменить</a>
                </td>
              </tr>
              {% endfor %}
              {% endif %}
            </tbody>
          </table>

          {% if clients %}
          {{ clients.pagination }}
          {% endif %}

        </div>
      </div>
    </div>
  </div>

  {% include "includes/footer.html" %}

</div>

{% endblock content %}

<!-- Specific JS goes HERE -->
{% block javascripts %}
<script>
var modal = $('#modal-system');

$(document).ready(function () {
    // Get Clients Form to Create or Edit
    $('#clientsList').on('click', '.get-client-form', function (event) {
        event.preventDefault();
        var btn = $(this);
        var url = btn.attr('href');
        var params = [];
        params['url'] = url;
        AjaxGETClientForm(params);
    });

    // Save client after click save-client class
    modal.on('click', '.save-client', function (event) {
        event.preventDefault();
        var btn = $(this);
        var form = btn.closest('form');
        var url = form.attr('action');
        var params = [];
        params['url'] = url;
        params['method'] = form.attr('method');
        params['query'] = form.serialize();
        AjaxPOSTClientForm(params);
    });
});


// Functions

function AjaxGETClientForm(params) {
    $.ajax({
        url: params['url'],
        type: 'GET',
        success: function (data) {
            modal.find('.modal-content').html(data.template);
            modal.modal();
        },
        error: function () {
            notification.error('Error occurred');
        }
    });
}


function AjaxPOSTClientForm(params) {
    $.ajax({
        url: params['url'],
        type: params['method'],
        data: params['query'],
        beforeSend: function (xhr) {
            xhr.setRequestHeader("X-CSRFToken", Cookies.get('csrftoken'));
        },
        success: function (data) {
            notification[data.valid](data.message);

            if (data.valid === 'success') {
                if (params['method'] === 'PUT')
                    $('.clients-list').find(".get-client-form[href='" + params['url'] + "']").closest('tr').replaceWith(data.item);
                else
                    $('.clients-list tbody').prepend(data.item);
                modal.modal('hide');

                setTimeout(function () {
                    location.reload();
                }, 2000);
            }
        },
        error: function () {
            notification.error('Error occurred');
        }
    });
}
</script>
{% endblock javascripts %}